<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>高知県 パーキング検索</title>

<!-- Leaflet（地図ライブラリ） -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body { margin:0; font-family:Arial; }
#topbar {
  padding:10px;
  background:#f0f0f0;
}
#map {
  height:90vh;
}
input {
  padding:8px;
  width:250px;
}
button {
  padding:8px;
}
</style>
</head>

<body>

<div id="topbar">
  <input id="searchInput" placeholder="例：ひろめ市場">
  <button onclick="searchPlace()">検索</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
let map = L.map('map').setView([33.5597,133.5311],15);
let markers = [];

// 地図タイル
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '© OpenStreetMap'
}).addTo(map);

// マーカー削除
function clearMarkers(){
  markers.forEach(m => map.removeLayer(m));
  markers = [];
}

// 目的地検索
async function searchPlace(){
  clearMarkers();

  const keyword = document.getElementById("searchInput").value + " 高知県";
  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(keyword)}`;

  const res = await fetch(url);
  const data = await res.json();

  if(data.length === 0){
    alert("場所が見つかりません");
    return;
  }

  const lat = data[0].lat;
  const lon = data[0].lon;

  map.setView([lat, lon], 16);

  const destMarker = L.marker([lat, lon]).addTo(map)
    .bindPopup("目的地")
    .openPopup();

  markers.push(destMarker);

  searchParking(lat, lon);
}

// 駐車場検索
async function searchParking(lat, lon){
  const overpassUrl = `
  https://overpass-api.de/api/interpreter?data=
  [out:json];
  node["amenity"="parking"](around:500,${lat},${lon});
  out;
  `;

  const res = await fetch(overpassUrl);
  const data = await res.json();

  data.elements.forEach(p => {
    const name = p.tags.name || "駐車場";
    const marker = L.marker([p.lat, p.lon], {
      icon: L.icon({
        iconUrl: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png",
        iconSize: [32,32]
      })
    }).addTo(map)
    .bindPopup(name);

    markers.push(marker);
  });
}
</script>

</body>
</html>

